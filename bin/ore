#!/usr/bin/env ruby

require_relative '../src/ore'

INSTRUCTIONS = <<~INST
    Usage: ore <command> <input>

    Run Ore programs or inspect compilation stages.

    COMMANDS:
		ore (-v | --version)            Show version number
		ore (-h | --help)               Show help instructions

		ore <file>                      Run file with hot reload

        ore lex <code>                  Show lexer tokens for code
        ore lexf <file>                 Show lexer tokens for file

        ore parse <code>                Show AST for code
        ore parsef <file>               Show AST for file

        ore interp <code>               Execute code string
        ore interpf <file>              Execute file

    EXAMPLES:
        ore myapp.ore
        ore lex "x = 5 + 3"
        ore parse -f test.ore
        ore interp myapp.ore
INST

if ARGV.empty?
	puts INSTRUCTIONS
	exit 1
end

begin
	case ARGV[0]
	when '-v', '--version'
		puts "Ore #{Ore::VERSION}"
		exit 0
	when '-h', '--help'
		puts INSTRUCTIONS
		exit 0
	when 'lex'
		pp Ore.lex ARGV[1]
	when 'parse'
		pp Ore.parse ARGV[1]
	when 'interp'
		pp Ore.interp ARGV[1]
	when 'lexf'
		pp Ore.lex_file ARGV[1]
	when 'parsef'
		pp Ore.parse_file ARGV[1]
	when 'interpf'
		pp Ore.interp_file ARGV[1]
	when 'interp-nostd'
		pp Ore.interp ARGV[1], with_std: false
	when 'interpf-nostd'
		pp Ore.interp_file ARGV[1], with_std: false
	else
		if ARGV[0]
			puts Ore.interp_file_with_hot_reload ARGV[0]
		else
			puts "Error: No file specified.\n#{INSTRUCTIONS}"
			exit 1
		end
	end
rescue Errno::ENOENT => e
	$stderr.puts "Could not find file `#{ARGV[0]}`"
	exit 1

rescue Ore::Error => e
	$stderr.puts e.message
	exit 1
end
